FROM congliu0913/ros2:mkl-opencl

MAINTAINER Liu Cong "congliu0913@126.com"

ARG DEPS_DIR=/root/deps

#install cmake 3.11
WORKDIR $DEPS_DIR
RUN wget https://www.cmake.org/files/v3.14/cmake-3.14.3.tar.gz && \
    tar xf cmake-3.14.3.tar.gz && \
    (cd cmake-3.14.3 && ./bootstrap --parallel=$(nproc --all) && make --jobs=$(nproc --all) && make install) && \
    rm -rf cmake-3.14.3 cmake-3.14.3.tar.gz

#install openvino
WORKDIR $DEPS_DIR
RUN apt-get update && apt-get install -y git
RUN git clone --depth 1 https://github.com/openvinotoolkit/openvino -b 2019_R3.1
WORKDIR $DEPS_DIR/openvino/inference-engine
RUN git submodule update --init --recursive &&\
    chmod +x install_dependencies.sh &&\
    ./install_dependencies.sh
RUN mkdir build && cd build &&\
    cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DGEMM=MKL -DMKLROOT=/usr/local/lib/mklml -DENABLE_MKL_DNN=ON -DENABLE_CLDNN=ON .. &&\
WORKDIR $DEPS_DIR/openvino/inference-engine/build
RUN make -j8

WORKDIR $DEPS_DIR/openvino/inference-engine/build
RUN mkdir /usr/share/InferenceEngine &&\
    cp InferenceEngineConfig*.cmake /usr/share/InferenceEngine &&\
    cp targets.cmake /usr/share/InferenceEngine &&\
    echo `pwd`/../bin/intel64/Release/lib | sudo tee -a /etc/ld.so.conf.d/openvino.conf &&\
   ldconfig

